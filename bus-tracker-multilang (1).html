<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="title">School Bus Tracker - Live GPS</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
  /* ===== Unique "Aurora Glass" Theme (inline) ===== */
  :root {
    --blue: #7aa8ff;
    --green: #7ee787;
    --yellow: #ffe178;
    --purple: #caa6ff;
    --glass: rgba(28, 33, 55, 0.55);
    --glass-strong: rgba(28, 33, 55, 0.75);
    --outline: #4b5a86;
    --text-dim: #c8d1e6;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    color: #fff;
    background:
      radial-gradient( 1200px 600px at -10% -10%, #1a2b6c 0%, transparent 40% ),
      radial-gradient( 900px 900px at 110% 10%, #5b1474 0%, transparent 50% ),
      radial-gradient( 1000px 900px at 50% 120%, #083c65 0%, transparent 50% ),
      linear-gradient(180deg, #0b1221 0%, #0c1428 100%);
    background-attachment: fixed;
    line-height: 1.5;
  }
  .blur {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  /* HEADER */
  .app-header {
    background: var(--glass);
    border-bottom: 1px solid var(--outline);
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .logo-section { display: flex; align-items: center; gap: .75rem; }
  .logo-icon {
    font-size: 1.25rem;
    width: 40px; height: 40px; border-radius: 10px;
    display: grid; place-items: center;
    background: linear-gradient(135deg, var(--blue), #5f78ff);
    box-shadow: 0 6px 20px rgba(122,168,255,.35), inset 0 0 18px rgba(255,255,255,.15);
  }
  .logo-section h1 { font-size: 1.15rem; font-weight: 700; letter-spacing: .3px; }
  .tagline { font-size: .85rem; color: var(--text-dim); }

  .header-right { display: flex; align-items: center; gap: .75rem; }
  .last-update { font-size: .85rem; color: var(--text-dim); }

  .icon-btn, .sos-btn {
    border: 1px solid var(--outline);
    background: var(--glass-strong);
    color: #fff;
    padding: .45rem .7rem;
    border-radius: 10px;
    cursor: pointer;
    transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
  }
  .icon-btn:hover { box-shadow: 0 6px 18px rgba(122,168,255,.25); }
  .icon-btn:active { transform: translateY(1px); }

  .sos-btn {
    background: linear-gradient(135deg, #ff3b30, #b91c1c);
    font-weight: 700;
  }
  .sos-btn:hover { box-shadow: 0 10px 24px rgba(255,59,48,.35); }

  /* NAV */
  .main-nav {
    background: var(--glass);
    border-bottom: 1px solid var(--outline);
    display: flex; overflow-x: auto;
  }
  .main-nav button {
    flex: 1 0 auto;
    padding: .8rem 1rem; border: 0;
    background: transparent; color: #d7e2ff;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: .2s ease;
    white-space: nowrap;
  }
  .main-nav button:hover { color: #fff; background: rgba(255,255,255,.04); }
  .main-nav button.active { color: var(--yellow); border-bottom-color: var(--yellow); }

  /* CONTENT */
  .content { padding: 1rem; }
  .view { display: none; }
  .view.active { display: block; }

  /* GRID STATS */
  .stats-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
    gap: 1rem; margin-bottom: 1.25rem;
  }
  .stats-card {
    background: var(--glass);
    border: 1px solid var(--outline);
    border-radius: 14px;
    padding: 1rem;
    display: grid; grid-template-columns: 44px 1fr; gap: .8rem; align-items: center;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
  }
  .stats-icon { font-size: 1.35rem; filter: drop-shadow(0 4px 12px rgba(0,0,0,.35)); }
  .stats-card h3 { font-size: .95rem; font-weight: 700; color: #e8ecff; }
  .stats-card p { font-size: 1.6rem; font-weight: 800; letter-spacing: .3px; }
  .stats-card span { font-size: .8rem; color: var(--text-dim); }

  /* LAYOUT */
  .overview-main {
    display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;
  }
  .panel {
    background: var(--glass);
    border: 1px solid var(--outline);
    border-radius: 14px; padding: 1rem;
  }
  #map { height: 340px; width: 100%; border-radius: 10px; }

  /* LISTS */
  .bus-list {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
    gap: 1rem;
  }
  .bus-card {
    background: var(--glass);
    border: 1px solid var(--outline);
    border-radius: 14px; padding: 1rem;
    box-shadow: 0 6px 18px rgba(0,0,0,.25);
  }
  .status {
    display: inline-block; font-size: .75rem; padding: 2px 6px; border-radius: 6px; font-weight: 700;
  }
  .status.on-route { background: #0b8f65; }
  .status.delayed { background: #b91c1c; }
  .status.idle { background: #1e40af; }

  /* TOASTS */
  .toast {
    position: fixed; top: 18px; right: -360px;
    min-width: 260px; padding: 12px 16px; border-radius: 12px;
    background: var(--glass-strong); color: #fff; border: 1px solid var(--outline);
    box-shadow: 0 6px 26px rgba(0,0,0,.35);
    transition: all .35s ease; z-index: 9999;
  }
  .toast.show { right: 18px; }
  .toast.info { border-color: #5f78ff; }
  .toast.success { border-color: #1fb167; }
  .toast.warning { border-color: #ffd166; color: #111; background: #ffd166; }
  .toast.error { border-color: #ff6b6b; background: linear-gradient(135deg, #ff3b30, #9b1c1c); }

  /* UTILS */
  .row { display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
  .grow { flex: 1; }
  .select {
    background: var(--glass-strong); color: #fff; border: 1px solid var(--outline);
    padding: .45rem .6rem; border-radius: 10px;
  }

  @media (max-width: 900px) {
    .overview-main { grid-template-columns: 1fr; }
  }
  </style>
</head>
<body>

<header class="app-header blur">
  <div class="logo-section">
    <div class="logo-icon">üöå</div>
    <div>
      <h1 data-i18n="app_name">School Bus Tracker</h1>
      <p class="tagline" data-i18n="tagline">Real-Time Tracking & Geofence Alerts</p>
    </div>
  </div>
  <div class="header-right row">
    <div class="row">
      <label for="lang" data-i18n="language">Language</label>
      <select id="lang" class="select"></select>
    </div>
    <button id="sosBtn" class="sos-btn" data-i18n="sos">SOS</button>
    <div class="last-update" data-i18n="last_updated">Last updated: <span id="lastUpdate">--:--:--</span></div>
    <button class="icon-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
  </div>
</header>

<nav class="main-nav blur">
  <button class="active" onclick="showView('overview', event)" data-i18n="tab_overview">Overview</button>
  <button onclick="showView('buses', event)" data-i18n="tab_buses">Bus Fleet</button>
  <button onclick="showView('students', event)" data-i18n="tab_students">Students</button>
  <button onclick="showView('administrators', event)" data-i18n="tab_administrators">Administrators</button>
  <button onclick="showView('alerts', event)" data-i18n="tab_alerts">Alerts</button>
</nav>

<main class="content">
  <!-- Overview Tab -->
  <section id="overview" class="view active">
    <div class="stats-grid">
      <div class="stats-card">
        <div class="stats-icon">üöå</div>
        <div>
          <h3 data-i18n="stat_total_buses">Total Buses</h3>
          <p id="statTotalBuses">0</p>
          <span data-i18n="fleet_size">Fleet size</span>
        </div>
      </div>
      <div class="stats-card">
        <div class="stats-icon">üìç</div>
        <div>
          <h3 data-i18n="stat_active_routes">Active Routes</h3>
          <p id="statActiveBuses">0</p>
          <span data-i18n="currently_on_route">Currently on route</span>
        </div>
      </div>
      <div class="stats-card">
        <div class="stats-icon">üë•</div>
        <div>
          <h3 data-i18n="stat_students_tracking">Students Tracking</h3>
          <p id="statTotalStudents">0</p>
          <span data-i18n="total_enrolled">Total enrolled</span>
        </div>
      </div>
      <div class="stats-card">
        <div class="stats-icon">‚ö†Ô∏è</div>
        <div>
          <h3 data-i18n="stat_delays">Delays</h3>
          <p id="statDelayedBuses">0</p>
          <span data-i18n="behind_schedule">Behind schedule</span>
        </div>
      </div>
    </div>
    <div class="overview-main">
      <div class="panel">
        <h2 data-i18n="live_map">Live Bus Map</h2>
        <div id="map"></div>
      </div>
      <div class="panel">
        <h2 data-i18n="recent_alerts">Recent Alerts</h2>
        <ul id="recentAlerts"></ul>
      </div>
    </div>
  </section>

  <!-- Bus Fleet Tab -->
  <section id="buses" class="view">
    <h2 data-i18n="bus_fleet">Bus Fleet</h2>
    <div id="busList" class="bus-list"></div>
  </section>

  <!-- Students Tab -->
  <section id="students" class="view">
    <h2 data-i18n="student_list">Student List</h2>
    <ul id="studentList" class="student-list"></ul>
  </section>

  <!-- Administrators Tab -->
  <section id="administrators" class="view">
    <h2 data-i18n="administrator_list">Administrator List</h2>
    <ul id="administratorList" class="administrator-list"></ul>
  </section>

  <!-- Alerts Tab -->
  <section id="alerts" class="view">
    <h2 data-i18n="all_alerts">All Alerts</h2>
    <ul id="allAlerts" class="alert-list"></ul>
  </section>
</main>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ========= Multilingual Engine ========= */
const TRANSLATIONS = {
  en: {
    title: "School Bus Tracker - Live GPS",
    app_name: "School Bus Tracker",
    tagline: "Real-Time Tracking & Geofence Alerts",
    language: "Language",
    sos: "SOS",
    last_updated: "Last updated: ",
    tab_overview: "Overview",
    tab_buses: "Bus Fleet",
    tab_students: "Students",
    tab_administrators: "Administrators",
    tab_alerts: "Alerts",
    stat_total_buses: "Total Buses",
    stat_active_routes: "Active Routes",
    stat_students_tracking: "Students Tracking",
    stat_delays: "Delays",
    fleet_size: "Fleet size",
    currently_on_route: "Currently on route",
    total_enrolled: "Total enrolled",
    behind_schedule: "Behind schedule",
    live_map: "Live Bus Map",
    recent_alerts: "Recent Alerts",
    bus_fleet: "Bus Fleet",
    student_list: "Student List",
    administrator_list: "Administrator List",
    all_alerts: "All Alerts",
    toast_enter: "{bus} has entered the school zone",
    toast_leave: "{bus} has left the school zone",
    toast_sos: "SOS Alert from {bus} sent to authorities!"
  },
  ta: {
    title: "‡Æ™‡Æ≥‡Øç‡Æ≥‡Æø ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ - ‡Æ®‡Øá‡Æ∞‡Æü‡Æø GPS",
    app_name: "‡Æ™‡Æ≥‡Øç‡Æ≥‡Æø ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ",
    tagline: "‡Æâ‡Æü‡Æ©‡Æü‡Æø ‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ & ‡Æú‡Æø‡ÆØ‡Øã‡Æ™‡ØÜ‡Æ©‡Øç‡Æ∏‡Øç ‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç",
    language: "‡ÆÆ‡Øä‡Æ¥‡Æø",
    sos: "‡Æé‡Æ∏‡Øç.‡Æì.‡Æé‡Æ∏‡Øç",
    last_updated: "‡Æï‡Æü‡Øà‡Æö‡Æø‡ÆØ‡Ææ‡Æï ‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æ§‡Øç‡Æ§‡Æ§‡ØÅ: ",
    tab_overview: "‡ÆÆ‡Øá‡Æ≤‡Øã‡Æü‡Øç‡Æü‡ÆÆ‡Øç",
    tab_buses: "‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øç",
    tab_students: "‡ÆÆ‡Ææ‡Æ£‡Æµ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç",
    tab_administrators: "‡Æ®‡Æø‡Æ∞‡Øç‡Æµ‡Ææ‡Æï‡Æø‡Æï‡Æ≥‡Øç",
    tab_alerts: "‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç",
    stat_total_buses: "‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Øç",
    stat_active_routes: "‡Æö‡ØÜ‡ÆØ‡Æ≤‡Æø‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥ ‡Æ™‡Ææ‡Æ§‡Øà‡Æï‡Æ≥‡Øç",
    stat_students_tracking: "‡ÆÆ‡Ææ‡Æ£‡Æµ‡Æ∞‡Øç ‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ",
    stat_delays: "‡Æ§‡Ææ‡ÆÆ‡Æ§‡Æô‡Øç‡Æï‡Æ≥‡Øç",
    fleet_size: "‡Æ™‡Æü‡Øà ‡ÆÖ‡Æ≥‡Æµ‡ØÅ",
    currently_on_route: "‡Æ®‡Æü‡Æ™‡Øç‡Æ™‡ØÅ‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ£‡ÆÆ‡Øç",
    total_enrolled: "‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ",
    behind_schedule: "‡ÆÖ‡Æü‡Øç‡Æü‡Æµ‡Æ£‡Øà‡Æï‡Øç‡Æï‡ØÅ ‡Æ™‡Æø‡Æ©‡Øç‡Æ©‡Ææ‡Æ≤‡Øç",
    live_map: "‡Æ®‡Øá‡Æ∞‡Æü‡Æø ‡Æµ‡Æ∞‡Øà‡Æ™‡Æü‡ÆÆ‡Øç",
    recent_alerts: "‡Æö‡ÆÆ‡ØÄ‡Æ™‡Æ§‡Øç‡Æ§‡Æø‡ÆØ ‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç",
    bus_fleet: "‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øç",
    student_list: "‡ÆÆ‡Ææ‡Æ£‡Æµ‡Æ∞‡Øç ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øç",
    administrator_list: "‡Æ®‡Æø‡Æ∞‡Øç‡Æµ‡Ææ‡Æï‡Æø ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øç",
    all_alerts: "‡ÆÖ‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡ØÅ ‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç",
    toast_enter: "{bus} ‡Æ™‡Æ≥‡Øç‡Æ≥‡Æø ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡ÆØ‡ØÅ‡Æ≥‡Øç ‡Æ®‡ØÅ‡Æ¥‡Øà‡Æ®‡Øç‡Æ§‡Æ§‡ØÅ",
    toast_leave: "{bus} ‡Æ™‡Æ≥‡Øç‡Æ≥‡Æø ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡ÆØ‡Øà ‡Æµ‡Æø‡Æü‡Øç‡Æü‡ØÅ ‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡Æø‡ÆØ‡Æ§‡ØÅ",
    toast_sos: "{bus} ‡Æá‡Æ≤‡Æø‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ SOS ‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ!"
  },
  hi: {
    title: "‡§∏‡•ç‡§ï‡•Ç‡§≤ ‡§¨‡§∏ ‡§ü‡•ç‡§∞‡•à‡§ï‡§∞ - ‡§≤‡§æ‡§á‡§µ GPS",
    app_name: "‡§∏‡•ç‡§ï‡•Ç‡§≤ ‡§¨‡§∏ ‡§ü‡•ç‡§∞‡•à‡§ï‡§∞",
    tagline: "‡§∞‡•Ä‡§Ø‡§≤-‡§ü‡§æ‡§á‡§Æ ‡§ü‡•ç‡§∞‡•à‡§ï‡§ø‡§Ç‡§ó ‡§î‡§∞ ‡§ú‡§ø‡§Ø‡•ã‡§´‡•á‡§Ç‡§∏ ‡§Ö‡§≤‡§∞‡•ç‡§ü‡•ç‡§∏",
    language: "‡§≠‡§æ‡§∑‡§æ",
    sos: "‡§è‡§∏‡§ì‡§è‡§∏",
    last_updated: "‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü: ",
    tab_overview: "‡§ì‡§µ‡§∞‡§µ‡•ç‡§Ø‡•Ç",
    tab_buses: "‡§¨‡§∏ ‡§∏‡•Ç‡§ö‡•Ä",
    tab_students: "‡§õ‡§æ‡§§‡•ç‡§∞",
    tab_administrators: "‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§ï",
    tab_alerts: "‡§Ö‡§≤‡§∞‡•ç‡§ü",
    stat_total_buses: "‡§ï‡•Å‡§≤ ‡§¨‡§∏‡•á‡§Ç",
    stat_active_routes: "‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§∞‡•Ç‡§ü",
    stat_students_tracking: "‡§õ‡§æ‡§§‡•ç‡§∞ ‡§ü‡•ç‡§∞‡•à‡§ï‡§ø‡§Ç‡§ó",
    stat_delays: "‡§µ‡§ø‡§≤‡§Ç‡§¨",
    fleet_size: "‡§¨‡•á‡§°‡§º‡•á ‡§ï‡§æ ‡§Ü‡§ï‡§æ‡§∞",
    currently_on_route: "‡§∞‡•Ç‡§ü ‡§™‡§∞",
    total_enrolled: "‡§ï‡•Å‡§≤ ‡§®‡§æ‡§Æ‡§æ‡§Ç‡§ï‡§ø‡§§",
    behind_schedule: "‡§∏‡§Æ‡§Ø ‡§∏‡•á ‡§™‡•Ä‡§õ‡•á",
    live_map: "‡§≤‡§æ‡§á‡§µ ‡§¨‡§∏ ‡§Æ‡§æ‡§®‡§ö‡§ø‡§§‡•ç‡§∞",
    recent_alerts: "‡§π‡§æ‡§≤‡§ø‡§Ø‡§æ ‡§Ö‡§≤‡§∞‡•ç‡§ü",
    bus_fleet: "‡§¨‡§∏ ‡§∏‡•Ç‡§ö‡•Ä",
    student_list: "‡§õ‡§æ‡§§‡•ç‡§∞ ‡§∏‡•Ç‡§ö‡•Ä",
    administrator_list: "‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§ï ‡§∏‡•Ç‡§ö‡•Ä",
    all_alerts: "‡§∏‡§≠‡•Ä ‡§Ö‡§≤‡§∞‡•ç‡§ü",
    toast_enter: "{bus} ‡§∏‡•ç‡§ï‡•Ç‡§≤ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§ï‡§∞ ‡§ó‡§à ‡§π‡•à",
    toast_leave: "{bus} ‡§∏‡•ç‡§ï‡•Ç‡§≤ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§∏‡•á ‡§¨‡§æ‡§π‡§∞ ‡§ó‡§à ‡§π‡•à",
    toast_sos: "{bus} ‡§∏‡•á SOS ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ!"
  },
  te: {
    title: "‡∞∏‡±ç‡∞ï‡±Ç‡∞≤‡±ç ‡∞¨‡∞∏‡±ç ‡∞ü‡±ç‡∞∞‡∞æ‡∞ï‡∞∞‡±ç - ‡∞≤‡±à‡∞µ‡±ç GPS",
    app_name: "‡∞∏‡±ç‡∞ï‡±Ç‡∞≤‡±ç ‡∞¨‡∞∏‡±ç ‡∞ü‡±ç‡∞∞‡∞æ‡∞ï‡∞∞‡±ç",
    tagline: "‡∞∞‡∞ø‡∞Ø‡∞≤‡±ç-‡∞ü‡±à‡∞Æ‡±ç ‡∞ü‡±ç‡∞∞‡∞æ‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç & ‡∞ú‡∞ø‡∞Ø‡±ã‡∞´‡±Ü‡∞®‡±ç‡∞∏‡±ç ‡∞Ö‡∞≤‡∞∞‡±ç‡∞ü‡±ç‡∞∏‡±ç",
    language: "‡∞≠‡∞æ‡∞∑",
    sos: "SOS",
    last_updated: "‡∞ö‡∞ø‡∞µ‡∞∞‡∞ø ‡∞®‡∞µ‡±Ä‡∞ï‡∞∞‡∞£: ",
    tab_overview: "‡∞ì‡∞µ‡∞∞‡±ç‡∞µ‡±ç‡∞Ø‡±Ç",
    tab_buses: "‡∞¨‡∞∏‡±ç‡∞∏‡±Å‡∞≤ ‡∞ú‡∞æ‡∞¨‡∞ø‡∞§‡∞æ",
    tab_students: "‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡∞æ‡∞∞‡±ç‡∞•‡±Å‡∞≤‡±Å",
    tab_administrators: "‡∞®‡∞ø‡∞∞‡±ç‡∞µ‡∞æ‡∞π‡∞ï‡±Å‡∞≤‡±Å",
    tab_alerts: "‡∞Ö‡∞≤‡∞∞‡±ç‡∞ü‡±ç‡∞∏‡±ç",
    stat_total_buses: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞¨‡∞∏‡±ç‡∞∏‡±Å‡∞≤‡±Å",
    stat_active_routes: "‡∞∏‡∞ï‡±ç‡∞∞‡∞ø‡∞Ø ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ó‡∞æ‡∞≤‡±Å",
    stat_students_tracking: "‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡∞æ‡∞∞‡±ç‡∞•‡∞ø ‡∞ü‡±ç‡∞∞‡∞æ‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç",
    stat_delays: "‡∞µ‡∞ø‡∞≤‡∞Ç‡∞¨‡∞æ‡∞≤‡±Å",
    fleet_size: "‡∞´‡±ç‡∞≤‡±Ä‡∞ü‡±ç ‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç",
    currently_on_route: "‡∞Æ‡∞æ‡∞∞‡±ç‡∞ó‡∞Ç‡∞≤‡±ã",
    total_enrolled: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞®‡∞Æ‡±ã‡∞¶‡±Å",
    behind_schedule: "‡∞∑‡±Ü‡∞°‡±ç‡∞Ø‡±Ç‡∞≤‡±ç‚Äå‡∞ï‡±Å ‡∞µ‡±Ü‡∞®‡±Å‡∞ï",
    live_map: "‡∞≤‡±à‡∞µ‡±ç ‡∞¨‡∞∏‡±ç ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç",
    recent_alerts: "‡∞§‡∞æ‡∞ú‡∞æ ‡∞Ö‡∞≤‡∞∞‡±ç‡∞ü‡±ç‡∞∏‡±ç",
    bus_fleet: "‡∞¨‡∞∏‡±ç‡∞∏‡±Å‡∞≤ ‡∞ú‡∞æ‡∞¨‡∞ø‡∞§‡∞æ",
    student_list: "‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡∞æ‡∞∞‡±ç‡∞•‡±Å‡∞≤ ‡∞ú‡∞æ‡∞¨‡∞ø‡∞§‡∞æ",
    administrator_list: "‡∞®‡∞ø‡∞∞‡±ç‡∞µ‡∞æ‡∞π‡∞ï‡±Å‡∞≤ ‡∞ú‡∞æ‡∞¨‡∞ø‡∞§‡∞æ",
    all_alerts: "‡∞Ö‡∞®‡±ç‡∞®‡∞ø ‡∞Ö‡∞≤‡∞∞‡±ç‡∞ü‡±ç‡∞∏‡±ç",
    toast_enter: "{bus} ‡∞™‡∞æ‡∞†‡∞∂‡∞æ‡∞≤ ‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞Ç‡∞≤‡±ã‡∞ï‡∞ø ‡∞™‡±ç‡∞∞‡∞µ‡±á‡∞∂‡∞ø‡∞Ç‡∞ö‡∞ø‡∞Ç‡∞¶‡∞ø",
    toast_leave: "{bus} ‡∞™‡∞æ‡∞†‡∞∂‡∞æ‡∞≤ ‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞Ç ‡∞®‡±Å‡∞Ç‡∞°‡∞ø ‡∞¨‡∞Ø‡∞ü‡∞ï‡±Å ‡∞µ‡±Ü‡∞≥‡±ç‡∞≤‡∞ø‡∞Ç‡∞¶‡∞ø",
    toast_sos: "{bus} ‡∞®‡±Å‡∞Ç‡∞°‡∞ø SOS ‡∞Ö‡∞≤‡∞∞‡±ç‡∞ü‡±ç ‡∞™‡∞Ç‡∞™‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø!"
  },
  ml: {
    title: "‡¥∏‡µç‡¥ï‡µÇ‡µæ ‡¥¨‡¥∏‡µç ‡¥ü‡µç‡¥∞‡¥æ‡¥ï‡µç‡¥ï‡µº - ‡¥§‡¥§‡µç‡¥∏‡¥Æ‡¥Ø GPS",
    app_name: "‡¥∏‡µç‡¥ï‡µÇ‡µæ ‡¥¨‡¥∏‡µç ‡¥ü‡µç‡¥∞‡¥æ‡¥ï‡µç‡¥ï‡µº",
    tagline: "‡¥§‡¥§‡µç‡¥∏‡¥Æ‡¥Ø ‡¥ü‡µç‡¥∞‡¥æ‡¥ï‡µç‡¥ï‡¥ø‡¥Ç‡¥ó‡µç & ‡¥ú‡¥ø‡¥Ø‡µã‡¥´‡µÜ‡µª‡¥∏‡µç ‡¥Ö‡¥≤‡µº‡¥ü‡µç‡¥ü‡µÅ‡¥ï‡µæ",
    language: "‡¥≠‡¥æ‡¥∑",
    sos: "SOS",
    last_updated: "‡¥Ö‡¥µ‡¥∏‡¥æ‡¥®‡¥Ç ‡¥™‡µÅ‡¥§‡µÅ‡¥ï‡µç‡¥ï‡¥ø‡¥Ø‡¥§‡µç: ",
    tab_overview: "‡¥ì‡¥µ‡µº‡¥µ‡µç‡¥Ø‡µÇ",
    tab_buses: "‡¥¨‡¥∏‡µç ‡¥™‡¥ü‡µç‡¥ü‡¥ø‡¥ï",
    tab_students: "‡¥µ‡¥ø‡¥¶‡µç‡¥Ø‡¥æ‡µº‡¥§‡µç‡¥•‡¥ø‡¥ï‡µæ",
    tab_administrators: "‡¥®‡¥ø‡¥∞‡µç‡¥µ‡¥æ‡¥π‡¥ï‡µº",
    tab_alerts: "‡¥Ö‡¥≤‡µº‡¥ü‡µç‡¥ü‡µÅ‡¥ï‡µæ",
    stat_total_buses: "‡¥Ü‡¥ï‡µÜ ‡¥¨‡¥∏‡µÅ‡¥ï‡µæ",
    stat_active_routes: "‡¥∏‡¥ú‡µÄ‡¥µ ‡¥±‡µÇ‡¥ü‡µç‡¥ü‡µÅ‡¥ï‡µæ",
    stat_students_tracking: "‡¥µ‡¥ø‡¥¶‡µç‡¥Ø‡¥æ‡µº‡¥§‡µç‡¥•‡¥ø ‡¥ü‡µç‡¥∞‡¥æ‡¥ï‡µç‡¥ï‡¥ø‡¥Ç‡¥ó‡µç",
    stat_delays: "‡¥§‡¥æ‡¥Æ‡¥∏‡¥ô‡µç‡¥ô‡µæ",
    fleet_size: "‡¥´‡µç‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥µ‡¥≤‡µÅ‡¥™‡µç‡¥™‡¥Ç",
    currently_on_route: "‡¥±‡µÇ‡¥ü‡µç‡¥ü‡¥ø‡µΩ",
    total_enrolled: "‡¥Ü‡¥ï‡µÜ ‡¥ö‡µá‡µº‡¥§‡µç‡¥§‡¥µ‡µº",
    behind_schedule: "‡¥∑‡µÜ‡¥°‡µç‡¥Ø‡µÇ‡¥≥‡¥ø‡¥®‡µç ‡¥™‡¥ø‡¥®‡µç‡¥®‡¥ø‡µΩ",
    live_map: "‡¥≤‡µà‡¥µ‡µç ‡¥¨‡¥∏‡µç ‡¥Æ‡¥æ‡¥™‡µç‡¥™‡µç",
    recent_alerts: "‡¥∏‡¥Æ‡µÄ‡¥™‡¥ï‡¥æ‡¥≤ ‡¥Ö‡¥≤‡µº‡¥ü‡µç‡¥ü‡µÅ‡¥ï‡µæ",
    bus_fleet: "‡¥¨‡¥∏‡µç ‡¥™‡¥ü‡µç‡¥ü‡¥ø‡¥ï",
    student_list: "‡¥µ‡¥ø‡¥¶‡µç‡¥Ø‡¥æ‡µº‡¥§‡µç‡¥•‡¥ø ‡¥™‡¥ü‡µç‡¥ü‡¥ø‡¥ï",
    administrator_list: "‡¥®‡¥ø‡¥∞‡µç‡¥µ‡¥æ‡¥π‡¥ï ‡¥™‡¥ü‡µç‡¥ü‡¥ø‡¥ï",
    all_alerts: "‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥Ö‡¥≤‡µº‡¥ü‡µç‡¥ü‡µÅ‡¥ï‡¥≥‡µÅ‡¥Ç",
    toast_enter: "{bus} ‡¥∏‡µç‡¥ï‡µÇ‡µæ ‡¥Æ‡µá‡¥ñ‡¥≤‡¥Ø‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥™‡µç‡¥∞‡¥µ‡µá‡¥∂‡¥ø‡¥ö‡µç‡¥ö‡µÅ",
    toast_leave: "{bus} ‡¥∏‡µç‡¥ï‡µÇ‡µæ ‡¥™‡µç‡¥∞‡¥¶‡µá‡¥∂‡¥§‡µç‡¥§‡µÅ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç ‡¥™‡µÅ‡¥±‡¥§‡µç‡¥§‡¥ø‡¥±‡¥ô‡µç‡¥ô‡¥ø",
    toast_sos: "{bus} ‡¥®‡¥ø‡¥®‡µç‡¥®‡µÅ‡¥Ç SOS ‡¥Ö‡¥≤‡µº‡¥ü‡µç‡¥ü‡µç ‡¥Ö‡¥Ø‡¥ö‡µç‡¥ö‡µÅ!"
  },
  kn: {
    title: "‡≤∏‡≥ç‡≤ï‡≥Ç‡≤≤‡≥ç ‡≤¨‡≤∏‡≥ç ‡≤ü‡≥ç‡≤∞‡≥ç‡≤Ø‡≤æ‡≤ï‡≤∞‡≥ç - ‡≤≤‡≥à‡≤µ‡≥ç GPS",
    app_name: "‡≤∏‡≥ç‡≤ï‡≥Ç‡≤≤‡≥ç ‡≤¨‡≤∏‡≥ç ‡≤ü‡≥ç‡≤∞‡≥ç‡≤Ø‡≤æ‡≤ï‡≤∞‡≥ç",
    tagline: "‡≤∞‡≤ø‡≤Ø‡≤≤‡≥ç-‡≤ü‡≥à‡≤Æ‡≥ç ‡≤ü‡≥ç‡≤∞‡≥ç‡≤Ø‡≤æ‡≤ï‡≤ø‡≤Ç‡≤ó‡≥ç ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤ú‡≤ø‡≤Ø‡≥ã‡≤´‡≥Ü‡≤®‡≥ç‡≤∏‡≥ç ‡≤é‡≤ö‡≥ç‡≤ö‡≤∞‡≤ø‡≤ï‡≥Ü",
    language: "‡≤≠‡≤æ‡≤∑‡≥Ü",
    sos: "SOS",
    last_updated: "‡≤ï‡≥ä‡≤®‡≥Ü‡≤Ø ‡≤®‡≤µ‡≥Ä‡≤ï‡≤∞‡≤£: ",
    tab_overview: "‡≤í‡≤µ‡≤∞‡≥ç‚Äå‡≤µ‡≥ç‡≤Ø‡≥Ç",
    tab_buses: "‡≤¨‡≤∏‡≥ç ‡≤™‡≤ü‡≥ç‡≤ü‡≤ø",
    tab_students: "‡≤µ‡≤ø‡≤¶‡≥ç‡≤Ø‡≤æ‡≤∞‡≥ç‡≤•‡≤ø‡≤ó‡≤≥‡≥Å",
    tab_administrators: "‡≤®‡≤ø‡≤∞‡≥ç‡≤µ‡≤æ‡≤π‡≤ï‡≤∞‡≥Å",
    tab_alerts: "‡≤é‡≤ö‡≥ç‡≤ö‡≤∞‡≤ø‡≤ï‡≥Ü",
    stat_total_buses: "‡≤í‡≤ü‡≥ç‡≤ü‡≥Å ‡≤¨‡≤∏‡≥ç‚Äå‡≤ó‡≤≥‡≥Å",
    stat_active_routes: "‡≤∏‡≤ï‡≥ç‡≤∞‡≤ø‡≤Ø ‡≤Æ‡≤æ‡≤∞‡≥ç‡≤ó‡≤ó‡≤≥‡≥Å",
    stat_students_tracking: "‡≤µ‡≤ø‡≤¶‡≥ç‡≤Ø‡≤æ‡≤∞‡≥ç‡≤•‡≤ø ‡≤ü‡≥ç‡≤∞‡≥ç‡≤Ø‡≤æ‡≤ï‡≤ø‡≤Ç‡≤ó‡≥ç",
    stat_delays: "‡≤µ‡≤ø‡≤≥‡≤Ç‡≤¨‡≤ó‡≤≥‡≥Å",
    fleet_size: "‡≤´‡≥ç‡≤≤‡≥Ä‡≤ü‡≥ç ‡≤ó‡≤æ‡≤§‡≥ç‡≤∞",
    currently_on_route: "‡≤Æ‡≤æ‡≤∞‡≥ç‡≤ó‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø",
    total_enrolled: "‡≤í‡≤ü‡≥ç‡≤ü‡≥Å ‡≤¶‡≤æ‡≤ñ‡≤≤‡≥Ü",
    behind_schedule: "‡≤ï‡≤æ‡≤≤‡≤ï‡≤ü‡≥ç‡≤ü‡≤ø‡≤ó‡≥Ü ‡≤π‡≤ø‡≤Ç‡≤¶‡≥Ü",
    live_map: "‡≤≤‡≥à‡≤µ‡≥ç ‡≤¨‡≤∏‡≥ç ‡≤®‡≤ï‡≥ç‡≤∑‡≥Ü",
    recent_alerts: "‡≤á‡≤§‡≥ç‡≤§‡≥Ä‡≤ö‡≤ø‡≤® ‡≤é‡≤ö‡≥ç‡≤ö‡≤∞‡≤ø‡≤ï‡≥Ü",
    bus_fleet: "‡≤¨‡≤∏‡≥ç ‡≤™‡≤ü‡≥ç‡≤ü‡≤ø",
    student_list: "‡≤µ‡≤ø‡≤¶‡≥ç‡≤Ø‡≤æ‡≤∞‡≥ç‡≤•‡≤ø ‡≤™‡≤ü‡≥ç‡≤ü‡≤ø",
    administrator_list: "‡≤®‡≤ø‡≤∞‡≥ç‡≤µ‡≤æ‡≤π‡≤ï ‡≤™‡≤ü‡≥ç‡≤ü‡≤ø",
    all_alerts: "‡≤é‡≤≤‡≥ç‡≤≤ ‡≤é‡≤ö‡≥ç‡≤ö‡≤∞‡≤ø‡≤ï‡≥Ü",
    toast_enter: "{bus} ‡≤∂‡≤æ‡≤≤‡≤æ ‡≤™‡≥ç‡≤∞‡≤¶‡≥á‡≤∂‡≤ï‡≥ç‡≤ï‡≥Ü ‡≤™‡≥ç‡≤∞‡≤µ‡≥á‡≤∂‡≤ø‡≤∏‡≤ø‡≤¶‡≥Ü",
    toast_leave: "{bus} ‡≤∂‡≤æ‡≤≤‡≤æ ‡≤™‡≥ç‡≤∞‡≤¶‡≥á‡≤∂‡≤¶‡≤ø‡≤Ç‡≤¶ ‡≤π‡≥ä‡≤∞‡≤ü‡≤ø‡≤¶‡≥Ü",
    toast_sos: "{bus} ‡≤ï‡≤°‡≥Ü‡≤Ø‡≤ø‡≤Ç‡≤¶ SOS ‡≤é‡≤ö‡≥ç‡≤ö‡≤∞‡≤ø‡≤ï‡≥Ü ‡≤ï‡≤≥‡≥Å‡≤π‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü!"
  }
};

const SUPPORTED = Object.keys(TRANSLATIONS);
const LANGUAGE_NAMES = new Intl.DisplayNames(SUPPORTED, { type: 'language' });

function populateLanguageSelect() {
  const sel = document.getElementById('lang');
  sel.innerHTML = '';
  SUPPORTED.forEach(code => {
    const opt = document.createElement('option');
    opt.value = code;
    // Fallback to code if display name fails
    let label = (LANGUAGE_NAMES.of(code) || code).toString();
    // English endonyms for clarity
    const labels = { en: "English", hi: "Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)", ta: "Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)", te: "Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)", ml: "Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)", kn: "Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)" };
    opt.textContent = labels[code] || label;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', () => setLanguage(sel.value));
}

function setLanguage(lang) {
  if (!SUPPORTED.includes(lang)) lang = 'en';
  localStorage.setItem('lang', lang);
  document.documentElement.lang = lang;
  const dict = TRANSLATIONS[lang];

  // Update static strings
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (!key) return;
    if (el.tagName.toLowerCase() === 'title') {
      document.title = dict[key] || TRANSLATIONS.en[key] || document.title;
    } else if (el.id === 'lastUpdate') {
      // skip: dynamic time is appended next to label
    } else {
      el.textContent = (dict[key] || TRANSLATIONS.en[key] || el.textContent);
    }
  });

  // Update tab button text
  document.querySelectorAll('.main-nav button[data-i18n]').forEach(btn => {
    const key = btn.getAttribute('data-i18n');
    btn.textContent = dict[key] || TRANSLATIONS.en[key] || btn.textContent;
  });

  // Update section headings
  document.querySelectorAll('section h2[data-i18n]').forEach(h2 => {
    const key = h2.getAttribute('data-i18n');
    h2.textContent = dict[key] || TRANSLATIONS.en[key] || h2.textContent;
  });

  // Prefix label for last updated
  const lastLabel = dict['last_updated'] || TRANSLATIONS.en['last_updated'];
  const container = document.querySelector('.last-update');
  if (container) {
    const timeSpan = document.getElementById('lastUpdate');
    container.innerHTML = `${lastLabel}<span id="lastUpdate">${timeSpan ? timeSpan.textContent : '--:--:--'}</span>`;
  }
}

function format(dictKey, values = {}) {
  const lang = localStorage.getItem('lang') || 'en';
  const dict = TRANSLATIONS[lang] || TRANSLATIONS.en;
  const tmpl = dict[dictKey] || TRANSLATIONS.en[dictKey] || '';
  return tmpl.replace(/\{(\w+)\}/g, (_, k) => values[k] ?? '');
}

/* ========= Original App Logic (merged & enhanced) ========= */
// ===== CONFIG =====
const busName = "6384564923"; // Change to your bus name or Traccar device ID
const geofenceRadius = 1000; // meters
const geofenceCenter = [28.6139, 77.2090]; // Example: New Delhi
let insideGeofence = false;

// ===== SAMPLE DATA =====
let buses = [
  {
    id: 1,
    number: "Bus-1",
    driver: "Sanju",
    route: "North Zone",
    status: "on-route",
    capacity: 40,
    gpsDeviceId: "6384564923"
  },
  {
    id: 2,
    number: "Bus-2",
    driver: "Sanjay",
    route: "East Zone",
    status: "delayed",
    capacity: 35,
    gpsDeviceId: "6384564924"
  },
  {
    id: 3,
    number: "Bus-3",
    driver: "Dhanush",
    route: "South Zone",
    status: "idle",
    capacity: 50,
    gpsDeviceId: "6384564925"
  }
];
let students = [
  { id: 101, name: "Abishek", bus: "Bus-1", grade: "5", parentContact: "9876543210" },
  { id: 102, name: "Vignesh", bus: "Bus-2", grade: "6", parentContact: "9876543211" },
  { id: 103, name: "Sam", bus: "Bus-3", grade: "7", parentContact: "9876543212" }
];
let alerts = [
  { id: 1, message: "Bus-2 is delayed by 10 minutes" },
  { id: 2, message: "Bus-1 is near your stop" }
];
let administrators = [
  { id: 1, name: "Principal Sharma", role: "Principal", contact: "principal@school.edu" },
  { id: 2, name: "Transport Manager Rao", role: "Transport Manager", contact: "transport@school.edu" }
];

// ===== TOASTS =====
function showToast(message, type = "info") {
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  requestAnimationFrame(() => toast.classList.add("show"));
  setTimeout(() => { toast.classList.remove("show"); setTimeout(() => toast.remove(), 300); }, 4800);
}

// ===== NAVIGATION =====
function showView(viewId, ev) {
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.getElementById(viewId).classList.add("active");
  document.querySelectorAll(".main-nav button").forEach(b => b.classList.remove("active"));
  if (ev && ev.target) ev.target.classList.add("active");
}

// ===== RENDER =====
function renderStats() {
  document.getElementById("statTotalBuses").textContent = buses.length;
  document.getElementById("statActiveBuses").textContent = buses.filter(b => b.status === "on-route").length;
  document.getElementById("statTotalStudents").textContent = students.length;
  document.getElementById("statDelayedBuses").textContent = buses.filter(b => b.status === "delayed").length;
}
function renderStudents() {
  const ul = document.getElementById("studentList"); ul.innerHTML = "";
  students.forEach(s => { const li = document.createElement("li"); li.textContent = `${s.name} - ${s.bus}`; ul.appendChild(li); });
}
function renderBuses() {
  const list = document.getElementById("busList"); list.innerHTML = "";
  buses.forEach(b => {
    const div = document.createElement("div");
    div.className = "bus-card";
    div.innerHTML = `<h4>${b.number}</h4>
      <p>Driver: ${b.driver}</p>
      <p>Route: ${b.route}</p>
      <span class="status ${b.status}">${b.status}</span>`;
    list.appendChild(div);
  });
}
function renderAlerts() {
  const recentList = document.getElementById("recentAlerts");
  const allList = document.getElementById("allAlerts");
  recentList.innerHTML = ""; allList.innerHTML = "";
  alerts.forEach(a => { const li = document.createElement("li"); li.textContent = a.message; allList.appendChild(li); });
  alerts.slice(0,5).forEach(a => { const li = document.createElement("li"); li.textContent = a.message; recentList.appendChild(li); });
}
function renderAdministrators() {
  const ul = document.getElementById("administratorList");
  ul.innerHTML = "";
  administrators.forEach(a => {
    const li = document.createElement("li");
    li.textContent = `${a.name} (${a.role}) - ${a.contact}`;
    ul.appendChild(li);
  });
}

// ===== MAP =====
let map = L.map('map').setView([28.6139, 77.2090], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);
let busMarker;
let geofenceCircle = L.circle(geofenceCenter, {
  color: "#7aa8ff", fillColor: "#7aa8ff", fillOpacity: 0.15, radius: geofenceRadius
}).addTo(map);

// ===== TRACCAR (DEMO) =====
// NOTE: Keep credentials secure in production. Use env vars/server proxy.
const traccarURL = `https://demo.traccar.org/api/positions?deviceId=${busName}`;
const traccarUsername = "MADHAVAN K";
const traccarPassword = "9790";

async function fetchBusLocation() {
  try {
    let res = await fetch(traccarURL, { headers: { "Authorization": "Basic " + btoa(`${traccarUsername}:${traccarPassword}`) } });
    let data = await res.json();
    if (!Array.isArray(data) || !data.length) return;
    const { latitude, longitude } = data[0];
    if (!busMarker) {
      busMarker = L.marker([latitude, longitude]).addTo(map)
        .bindPopup(`<b>${busName}</b><br>Route: North Zone`);
    } else {
      busMarker.setLatLng([latitude, longitude]);
    }
    checkGeofence(latitude, longitude);
  } catch (err) {
    console.error("Error fetching location:", err);
  }
}

function checkGeofence(lat, lng) {
  const distance = map.distance([lat, lng], geofenceCenter);
  if (distance <= geofenceRadius && !insideGeofence) {
    insideGeofence = true;
    showToast(format('toast_enter', { bus: busName }), "success");
  } else if (distance > geofenceRadius && insideGeofence) {
    insideGeofence = false;
    showToast(format('toast_leave', { bus: busName }), "warning");
  }
}

// ===== SOS =====
document.getElementById("sosBtn").addEventListener("click", () => {
  showToast(format('toast_sos', { bus: busName }), "error");
});

// ===== INIT =====
function init() {
  populateLanguageSelect();
  const preferred = localStorage.getItem('lang') || (navigator.language || 'en').slice(0,2);
  setLanguage(SUPPORTED.includes(preferred) ? preferred : 'en');
  document.getElementById('lang').value = localStorage.getItem('lang') || 'en';

  renderStats();
  renderStudents();
  renderBuses();
  renderAdministrators();
  renderAlerts();
  fetchBusLocation();
}
init();

// ===== AUTO REFRESH =====
setInterval(fetchBusLocation, 10000);
setInterval(() => {
  const t = new Date().toLocaleTimeString();
  const span = document.getElementById("lastUpdate");
  if (span) span.textContent = t;
}, 1000);
</script>
</body>
</html>
